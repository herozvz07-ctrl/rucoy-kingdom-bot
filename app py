import os
import asyncio
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram.utils.keyboard import InlineKeyboardBuilder

BOT_TOKEN = os.getenv("BOT_TOKEN")
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# ---------- –°–æ—Å—Ç–æ—è–Ω–∏—è ----------
class Registration(StatesGroup):
    waiting_nickname = State()
    waiting_class = State()

# ---------- –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –∫–ª–∞—Å—Å–∞ ----------
def class_keyboard():
    builder = InlineKeyboardBuilder()
    builder.add(types.InlineKeyboardButton(text="üßô –ú–∞–≥", callback_data="class_mage"))
    builder.add(types.InlineKeyboardButton(text="üèπ –õ—É—á–Ω–∏–∫", callback_data="class_archer"))
    builder.add(types.InlineKeyboardButton(text="‚öî –í–æ–∏–Ω", callback_data="class_warrior"))
    builder.adjust(1)
    return builder.as_markup()

# ---------- –•—ç–Ω–¥–ª–µ—Ä—ã ----------
@dp.message(Command("start"))
async def start(msg: types.Message, state: FSMContext):
    await msg.answer(
        "üè∞ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Rucoy Kingdom!\n\n–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –∏–º—è –≥–µ—Ä–æ—é:"
    )
    await state.set_state(Registration.waiting_nickname)

@dp.message(Registration.waiting_nickname)
async def get_nickname(msg: types.Message, state: FSMContext):
    await state.update_data(nickname=msg.text)
    info_text = (
        "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—É—Ç—å:\n"
        "üßô –ú–∞–≥: –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–Ω, —Å–ª–∞–±–∞—è –±—Ä–æ–Ω—è\n"
        "üèπ –õ—É—á–Ω–∏–∫: –±–∞–ª–∞–Ω—Å –∏ —Å–∫–æ—Ä–æ—Å—Ç—å\n"
        "‚öî –í–æ–∏–Ω: –º–Ω–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è –∏ –±—Ä–æ–Ω–∏"
    )
    await msg.answer(info_text, reply_markup=class_keyboard())
    await state.set_state(Registration.waiting_class)

@dp.callback_query(lambda c: c.data.startswith("class_"))
async def class_selected(call: types.CallbackQuery, state: FSMContext):
    data = await state.get_data()
    nickname = data.get("nickname")
    choice = call.data.split("_")[1]
    await call.message.answer(f"‚úÖ –ì–µ—Ä–æ–π {nickname} –≤—ã–±—Ä–∞–Ω! –ö–ª–∞—Å—Å: {choice}")
    await state.clear()

# ---------- –ó–∞–ø—É—Å–∫ ----------
async def main():
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
